name: Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

concurrency:
  group: code-review-${{ github.ref }}
  cancel-in-progress: true

jobs:
  review-complexity:
    name: Review / Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install analysis tools
        run: |
          python -m pip install --upgrade pip
          pip install radon lizard

      - name: Analyze code complexity
        id: complexity
        continue-on-error: true
        run: |
          echo "## Code Complexity Analysis" > complexity_report.md
          echo "" >> complexity_report.md
          
          # Cyclomatic complexity with radon for Python files
          echo "### Cyclomatic Complexity (Radon)" >> complexity_report.md
          echo "\`\`\`" >> complexity_report.md
          if [ -d "rag-pipeline" ]; then
            radon cc rag-pipeline/ -a -s || echo "No Python complexity issues found" >> complexity_report.md
          else
            echo "No Python code to analyze" >> complexity_report.md
          fi
          echo "\`\`\`" >> complexity_report.md
          echo "" >> complexity_report.md
          
          # Maintainability index
          echo "### Maintainability Index" >> complexity_report.md
          echo "\`\`\`" >> complexity_report.md
          if [ -d "rag-pipeline" ]; then
            radon mi rag-pipeline/ -s || echo "No maintainability issues" >> complexity_report.md
          else
            echo "No Python code to analyze" >> complexity_report.md
          fi
          echo "\`\`\`" >> complexity_report.md
          echo "" >> complexity_report.md
          
          # Halstead metrics
          echo "### Halstead Metrics" >> complexity_report.md
          echo "\`\`\`" >> complexity_report.md
          if [ -d "rag-pipeline" ]; then
            radon hal rag-pipeline/ || echo "No Halstead metrics available" >> complexity_report.md
          else
            echo "No Python code to analyze" >> complexity_report.md
          fi
          echo "\`\`\`" >> complexity_report.md

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        with:
          name: complexity-report
          path: complexity_report.md

      - name: Comment complexity results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('complexity_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  review-security:
    name: Review / Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]

      - name: Run Bandit security scan
        id: bandit
        continue-on-error: true
        run: |
          echo "## Security Scan Results (Bandit)" > security_report.md
          echo "" >> security_report.md
          echo "\`\`\`" >> security_report.md
          if [ -d "rag-pipeline" ]; then
            bandit -r rag-pipeline/ -f txt || echo "Security scan completed with warnings" >> security_report.md
          else
            echo "No Python code to scan" >> security_report.md
          fi
          echo "\`\`\`" >> security_report.md

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Comment security results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('security_report.md', 'utf8');
            } catch (e) {
              report = '## Security Scan Results\n\nSecurity scan completed. Check Security tab for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  review-impact:
    name: Review / Change Impact Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze PR impact
        id: impact
        run: |
          echo "## Change Impact Analysis" > impact_report.md
          echo "" >> impact_report.md
          
          # Get base and head commits
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Count changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | wc -l)
          echo "### Files Changed: $CHANGED_FILES" >> impact_report.md
          echo "" >> impact_report.md
          
          # Analyze areas affected
          echo "### Areas Affected:" >> impact_report.md
          echo "\`\`\`" >> impact_report.md
          git diff --name-only $BASE_SHA $HEAD_SHA | cut -d'/' -f1 | sort -u >> impact_report.md
          echo "\`\`\`" >> impact_report.md
          echo "" >> impact_report.md
          
          # File type breakdown
          echo "### File Types Changed:" >> impact_report.md
          echo "\`\`\`" >> impact_report.md
          git diff --name-only $BASE_SHA $HEAD_SHA | sed 's/.*\.//' | sort | uniq -c | sort -rn >> impact_report.md
          echo "\`\`\`" >> impact_report.md
          echo "" >> impact_report.md
          
          # Lines changed
          ADDITIONS=$(git diff --shortstat $BASE_SHA $HEAD_SHA | grep -oP '\d+(?= insertion)')
          DELETIONS=$(git diff --shortstat $BASE_SHA $HEAD_SHA | grep -oP '\d+(?= deletion)')
          echo "### Lines Changed:" >> impact_report.md
          echo "- Additions: ${ADDITIONS:-0}" >> impact_report.md
          echo "- Deletions: ${DELETIONS:-0}" >> impact_report.md
          echo "- Net Change: $((${ADDITIONS:-0} - ${DELETIONS:-0}))" >> impact_report.md
          echo "" >> impact_report.md
          
          # Warning for large PRs
          TOTAL_CHANGES=$((${ADDITIONS:-0} + ${DELETIONS:-0}))
          if [ $TOTAL_CHANGES -gt 1000 ]; then
            echo "âš ï¸ **Warning**: This is a large PR with $TOTAL_CHANGES line changes. Consider breaking it into smaller PRs." >> impact_report.md
          fi

      - name: Comment impact analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('impact_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  review-summary:
    name: Review / Summary
    needs: [review-complexity, review-security, review-impact]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create review summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ðŸ¤– Automated Code Review Complete
            
            The automated code review has finished analyzing your PR. Please review the comments above for:
            
            - âœ… Code complexity analysis
            - ðŸ”’ Security scan results
            - ðŸ“Š Change impact analysis
            
            All checks completed in approximately 5 minutes. Review the individual reports for detailed findings.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
